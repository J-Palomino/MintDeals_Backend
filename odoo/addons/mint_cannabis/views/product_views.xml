<?xml version="1.0" encoding="utf-8"?>
<odoo>

    <!-- Extend Product Template Form View -->
    <record id="product_template_form_view_cannabis" model="ir.ui.view">
        <field name="name">product.template.form.cannabis</field>
        <field name="model">product.template</field>
        <field name="inherit_id" ref="product.product_template_form_view"/>
        <field name="arch" type="xml">
            <!-- Add Cannabis tab to notebook -->
            <xpath expr="//notebook" position="inside">
                <page string="Cannabis" name="cannabis">
                    <group>
                        <group string="Classification">
                            <field name="x_is_cannabis"/>
                            <field name="x_strain_id"/>
                            <field name="x_strain_type"/>
                            <field name="x_brand_id"/>
                            <field name="x_product_category"/>
                            <field name="x_product_subcategory"/>
                            <field name="x_dosage_form"/>
                        </group>
                        <group string="Flags">
                            <field name="x_medical_only"/>
                            <field name="x_special_sale"/>
                            <field name="x_staff_pick"/>
                            <field name="x_featured"/>
                        </group>
                    </group>
                    <group>
                        <group string="Compliance">
                            <field name="x_regulatory_category"/>
                            <field name="x_flower_equivalent"/>
                            <field name="x_product_type"/>
                        </group>
                        <group string="Sync Information">
                            <field name="x_dutchie_product_id" readonly="1"/>
                            <field name="x_dutchie_pos_id" readonly="1"/>
                            <field name="x_synced_at" readonly="1"/>
                            <field name="x_sync_source"/>
                        </group>
                    </group>
                    <group string="Effects &amp; Profile">
                        <field name="x_effects" placeholder='["Relaxed", "Happy", "Euphoric"]'/>
                        <field name="x_tags" placeholder='["Bestseller", "New"]'/>
                    </group>
                    <group string="URLs">
                        <field name="x_slug"/>
                    </group>
                </page>
            </xpath>
        </field>
    </record>

    <!-- Extend Product Variant Form View -->
    <record id="product_product_form_view_cannabis" model="ir.ui.view">
        <field name="name">product.product.form.cannabis</field>
        <field name="model">product.product</field>
        <field name="inherit_id" ref="product.product_normal_form_view"/>
        <field name="arch" type="xml">
            <!-- Add Cannabis Variant tab to notebook -->
            <xpath expr="//notebook" position="inside">
                <page string="Cannabis Details" name="cannabis_details">
                    <group>
                        <group string="Potency">
                            <field name="x_thc_percentage"/>
                            <field name="x_cbd_percentage"/>
                            <field name="x_potency_thc_formatted" readonly="1"/>
                            <field name="x_potency_cbd_formatted" readonly="1"/>
                        </group>
                        <group string="Potency Range">
                            <field name="x_thc_percentage_min"/>
                            <field name="x_thc_percentage_max"/>
                            <field name="x_cbd_percentage_min"/>
                            <field name="x_cbd_percentage_max"/>
                        </group>
                    </group>
                    <group>
                        <group string="Milligrams">
                            <field name="x_thc_mg"/>
                            <field name="x_cbd_mg"/>
                            <field name="x_thc_mg_per_serving"/>
                            <field name="x_cbd_mg_per_serving"/>
                        </group>
                        <group string="Servings &amp; Weight">
                            <field name="x_servings"/>
                            <field name="x_net_weight"/>
                            <field name="x_net_weight_grams"/>
                            <field name="x_weight_unit"/>
                            <field name="x_size"/>
                        </group>
                    </group>
                    <group string="Terpenes">
                        <group>
                            <field name="x_terpene_myrcene"/>
                            <field name="x_terpene_limonene"/>
                            <field name="x_terpene_caryophyllene"/>
                        </group>
                        <group>
                            <field name="x_terpene_pinene"/>
                            <field name="x_terpene_linalool"/>
                            <field name="x_terpene_humulene"/>
                            <field name="x_total_terpenes"/>
                        </group>
                    </group>
                </page>
                <page string="Batch &amp; Testing" name="batch_testing">
                    <group>
                        <group string="Batch Information">
                            <field name="x_batch_id"/>
                            <field name="x_package_id"/>
                            <field name="x_harvest_date"/>
                            <field name="x_package_date"/>
                            <field name="x_expiration_date"/>
                        </group>
                        <group string="Lab Testing">
                            <field name="x_lab_test_status"/>
                            <field name="x_tested_date"/>
                        </group>
                    </group>
                </page>
                <page string="Pricing" name="cannabis_pricing">
                    <group>
                        <group string="Standard Pricing">
                            <field name="x_unit_cost"/>
                            <field name="x_price_rec"/>
                            <field name="x_price_med"/>
                        </group>
                        <group string="Special Pricing">
                            <field name="x_special_price"/>
                            <field name="x_special_price_rec"/>
                            <field name="x_special_price_med"/>
                        </group>
                    </group>
                </page>
                <page string="Inventory" name="cannabis_inventory">
                    <group>
                        <group string="Quantities">
                            <field name="x_quantity_available"/>
                            <field name="x_quantity_reserved"/>
                            <field name="x_quantity_on_floor"/>
                            <field name="x_quantity_in_back"/>
                        </group>
                        <group string="Reorder Settings">
                            <field name="x_low_stock_threshold"/>
                            <field name="x_reorder_point"/>
                        </group>
                    </group>
                </page>
                <page string="Dutchie Sync" name="dutchie_sync">
                    <group>
                        <group string="Identifiers">
                            <field name="x_dutchie_inventory_id" readonly="1"/>
                            <field name="x_dutchie_sku" readonly="1"/>
                            <field name="x_dutchie_location_id" readonly="1"/>
                            <field name="x_dutchie_pos_inventory_id" readonly="1"/>
                        </group>
                        <group string="Media">
                            <field name="x_image_url" widget="url"/>
                            <field name="x_images"/>
                        </group>
                    </group>
                    <group string="Sync Status">
                        <field name="x_synced_at" readonly="1"/>
                    </group>
                </page>
            </xpath>
        </field>
    </record>

    <!-- Cannabis Inventory List View (Product Variants by Store) -->
    <record id="product_product_list_view_cannabis_inventory" model="ir.ui.view">
        <field name="name">product.product.list.cannabis.inventory</field>
        <field name="model">product.product</field>
        <field name="arch" type="xml">
            <list string="Cannabis Inventory" default_order="x_quantity_available desc">
                <field name="company_id" string="Company" optional="show"/>
                <field name="default_code" string="SKU"/>
                <field name="name" string="Product"/>
                <field name="x_warehouse_id" string="Store"/>
                <field name="x_store_name" string="Store Name" optional="hide"/>
                <field name="x_quantity_available" string="Available" sum="Total Available"/>
                <field name="x_quantity_on_floor" string="On Floor" optional="show"/>
                <field name="list_price" string="Price"/>
                <field name="x_special_price" string="Sale Price" optional="show"/>
                <field name="x_thc_percentage" string="THC %" optional="show"/>
                <field name="x_cbd_percentage" string="CBD %" optional="show"/>
                <field name="x_batch_id" string="Batch" optional="hide"/>
                <field name="x_dutchie_location_id" string="Dutchie ID" optional="hide"/>
                <field name="x_synced_at" string="Last Sync" optional="hide"/>
            </list>
        </field>
    </record>

    <!-- Cannabis Inventory Search View -->
    <record id="product_product_search_view_cannabis_inventory" model="ir.ui.view">
        <field name="name">product.product.search.cannabis.inventory</field>
        <field name="model">product.product</field>
        <field name="arch" type="xml">
            <search string="Search Cannabis Inventory">
                <field name="name" string="Product"/>
                <field name="default_code" string="SKU"/>
                <field name="x_warehouse_id" string="Store"/>
                <field name="company_id" string="Company"/>
                <field name="x_batch_id" string="Batch"/>
                <separator/>
                <filter string="In Stock" name="in_stock" domain="[('x_quantity_available', '>', 0)]"/>
                <filter string="Out of Stock" name="out_of_stock" domain="[('x_quantity_available', '=', 0)]"/>
                <filter string="Low Stock" name="low_stock" domain="[('x_quantity_available', '>', 0), ('x_quantity_available', '&lt;', 5)]"/>
                <separator/>
                <filter string="On Sale" name="on_sale" domain="[('x_special_price', '>', 0)]"/>
                <filter string="Staff Pick" name="staff_pick" domain="[('product_tmpl_id.x_staff_pick', '=', True)]"/>
                <filter string="Medical Only" name="medical_only" domain="[('product_tmpl_id.x_medical_only', '=', True)]"/>
                <separator/>
                <filter string="High THC (&gt;20%)" name="high_thc" domain="[('x_thc_percentage', '>=', 20)]"/>
                <filter string="High CBD (&gt;10%)" name="high_cbd" domain="[('x_cbd_percentage', '>=', 10)]"/>
                <separator/>
                <group expand="0" string="Group By">
                    <filter string="Company" name="group_company" context="{'group_by': 'company_id'}"/>
                    <filter string="Store" name="group_store" context="{'group_by': 'x_warehouse_id'}"/>
                    <filter string="Category" name="group_category" context="{'group_by': 'categ_id'}"/>
                    <filter string="Brand" name="group_brand" context="{'group_by': 'product_tmpl_id.x_brand_id'}"/>
                    <filter string="Strain Type" name="group_strain_type" context="{'group_by': 'product_tmpl_id.x_strain_type'}"/>
                    <filter string="Batch" name="group_batch" context="{'group_by': 'x_batch_id'}"/>
                </group>
            </search>
        </field>
    </record>

    <!-- Cannabis Inventory Action -->
    <record id="action_cannabis_inventory" model="ir.actions.act_window">
        <field name="name">Cannabis Inventory</field>
        <field name="res_model">product.product</field>
        <field name="view_mode">list,form</field>
        <field name="view_id" ref="product_product_list_view_cannabis_inventory"/>
        <field name="search_view_id" ref="product_product_search_view_cannabis_inventory"/>
        <field name="domain">[('product_tmpl_id.x_is_cannabis', '=', True)]</field>
        <field name="context">{'search_default_in_stock': 1}</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                No cannabis inventory found
            </p>
            <p>
                Run the Dutchie sync to import inventory data.
            </p>
        </field>
    </record>

</odoo>
